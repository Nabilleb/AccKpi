<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Task</title>
<link rel="stylesheet" href="/css/all.min.css">
 <link rel="stylesheet" href="/styles/task.css">
</head>
<body data-process-id="<%= workflowDetails.ProcessID %>" data-process-steps='<%- JSON.stringify(processSteps) %>'>

<div class="navigation-buttons">
  <a href="/addProcess" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Close
  </a>
  <a href="/workFlowDash" class="btn btn-primary">
    <i class="fas fa-plus"></i> Create New Workflow
  </a>
</div>

<div class="form-container">
  <div class="form-header">
    <h1><i class="fas fa-tasks"></i>Create New Task</h1>
  </div>

  <% if (typeof success !== 'undefined' && success) { %>
    <div class="success-message">
      <i class="fas fa-check-circle"></i>
      <div><%= success %></div>
    </div>
  <% } %>

  <form id="taskForm" class="form-grid">
    <input type="hidden" name="ProcessID" value="<%= workflowDetails.ProcessID %>">
    
    <div class="workflow-info">
      <div><i class="fas fa-sitemap"></i> <strong>Process:</strong> <%= workflowDetails.ProcessName %></div>
      <div><i class="fas fa-layer-group"></i> <strong>Steps:</strong> <%= processSteps.length %></div>
    </div>

    <% if (processSteps && processSteps.length > 0) { %>
      <div class="process-steps">
        <h3><i class="fas fa-list-ol"></i> Process Steps</h3>
        <ol>
          <% processSteps.forEach(step => { %>
            <li><strong>Step <%= step.StepOrder %>:</strong> <%= step.DeptName %></li>
          <% }) %>
        </ol>
      </div>
    <% } %>

    <div class="form-group">
      <label for="DepId" class="required-field">Responsible Department</label>
      <select name="DepId" id="DepId" required>
        <option value="">Select a department</option>
        <% departments.forEach(d => { %>
          <option value="<%= d.DepartmentID %>" <%= d.DepartmentID === departmentId ? "selected" : "" %>><%= d.DeptName %></option>
        <% }) %>
      </select>
      <div class="validation-error" id="DepId-error">Please select a department</div>
    </div>

    <div class="form-group">
      <label for="TaskName" class="required-field">Task Name</label>
      <input type="text" name="TaskName" id="TaskName" required placeholder="Enter task name" maxlength="100"/>
      <div class="validation-error" id="TaskName-error">Task name is required</div>
    </div>

    <div class="form-group">
      <label for="TaskPlanned" class="required-field">Task Description</label>
      <textarea name="TaskPlanned" id="TaskPlanned" required placeholder="Describe what needs to be done" maxlength="255" rows="3"></textarea>
      <div class="char-counter" id="TaskPlanned-counter">0/255</div>
      <div class="validation-error" id="TaskPlanned-error">Description is required</div>
    </div>

    <div class="form-group">
      <label for="DaysRequired" class="required-field">Estimated Days</label>
      <input type="number" name="DaysRequired" id="DaysRequired" min="1" required placeholder="3"/>
      <div class="validation-error" id="DaysRequired-error">Please enter a valid number of days</div>
    </div>

    <div class="form-group checkbox-group">
      <label for="IsFixed-check" class="checkbox-label">
        <input type="hidden" name="IsFixed" id="IsFixed" value="0"/>
        <input type="checkbox" id="IsFixed-check" />
        <span class="checkbox-custom"></span>
        <span class="checkbox-text">Task is Fixed</span>
      </label>
      <small class="helper-text">Mark this task as fixed if it cannot be delayed</small>
    </div>

    <div class="form-group">
      <label for="linkTasks">Link to Task (Optional)</label>
      <select name="linkTasks" id="linkTasks" class="link-task-select">
        <option value="">-- No Link --</option>
      </select>
      <small class="helper-text">Link this task to another task to inherit its planned date</small>
    </div>

    <% if (!hasWorkflow) { %>
  <div class="form-actions">
    <button type="submit" class="btn btn-primary" id="submit-btn">
      <i class="fas fa-plus-circle"></i> Create Task
    </button>
  </div>
<% } else { %>
  <p class="text-danger">This process already has a workflow. You cannot create a new task.</p>
<% } %>

  </form>
  
  <div id="tasks-container">
    <div class="tasks-header">
      <h2><i class="fas fa-clipboard-list"></i> Current Tasks</h2>
      <div>
        <button class="refresh-btn" id="refresh-tasks">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    
    <div class="search-container">
      <input type="text" class="search-input" id="task-search" placeholder="Search tasks...">
      <select class="search-input" id="status-filter">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="in-progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="delayed">Delayed</option>
      </select>
    </div>
    
    <div id="tasks-loading">
      <!-- Loading skeleton -->
      <div class="skeleton-row"></div>
      <div class="skeleton-row"></div>
      <div class="skeleton-row"></div>
    </div>
    <div id="tasks-content" class="hidden"></div>
    
    <div class="pagination" id="pagination" class="hidden"></div>
  </div>
</div>

<!-- Edit Task Modal -->
<div id="edit-task-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Task</h2>
      <button class="modal-close" data-action="close-modal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-task-id">
      
      <div class="form-group">
        <label for="edit-task-name">Task Name *</label>
        <input type="text" id="edit-task-name" maxlength="100" placeholder="Task name">
      </div>
      
      <div class="form-group">
        <label for="edit-description">Description *</label>
        <textarea id="edit-description" maxlength="255" rows="3" placeholder="Task description"></textarea>
        <div class="char-counter" id="edit-description-counter">0/255</div>
      </div>

      <div class="form-group">
        <label for="edit-days">Days Required</label>
        <input type="number" id="edit-days" min="0" placeholder="0">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-action="close-modal">Cancel</button>
      <button class="btn-primary" onclick="saveTaskChanges()">Save Changes</button>
    </div>
  </div>
</div>

<script src="/js/task.js"></script>
</body>
</html>