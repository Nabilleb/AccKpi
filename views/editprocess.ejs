<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Process</title>
  <link rel="stylesheet" href="/css/all.min.css">
  <style>
    :root {
      --primary: #005bab;
      --primary-dark: #003f7f;
      --primary-light: #e6f0ff;
      --accent: #007acc;
      --accent-dark: #005f99;
      --text: #333333;
      --text-light: #666666;
      --border: #e0e0e0;
      --background: #f8fafc;
      --white: #ffffff;
      --success: #28a745;
      --danger: #dc3545;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--white);
      padding: 1rem 2rem;
      border-bottom: 3px solid var(--primary);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      height: 50px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .logout-btn {
      background-color: var(--primary);
      color: var(--white);
      padding: 0.5rem 1.25rem;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .logout-btn:hover {
      background-color: var(--primary-dark);
    }

    .main-content {
      max-width: 900px;
      width: 100%;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      margin-bottom: 1.5rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .back-link:hover {
      color: var(--primary-dark);
    }

    .page-title {
      color: var(--primary-dark);
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-title i {
      color: var(--accent);
    }

    .page-subtitle {
      color: var(--text-light);
      margin-bottom: 2rem;
    }

    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: var(--transition);
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 91, 171, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .help-text {
      display: block;
      margin-top: 0.4rem;
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .steps-container {
      background-color: var(--primary-light);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .steps-title {
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 1rem;
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      background-color: var(--white);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
    }

    .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background-color: var(--accent);
      color: var(--white);
      border-radius: 50%;
      font-weight: 600;
    }

    .step-info {
      flex: 1;
    }

    .step-dept-name {
      font-weight: 600;
      color: var(--text);
    }

    .step-actions {
      display: flex;
      gap: 0.5rem;
    }

    .remove-btn {
      background-color: var(--danger);
      color: var(--white);
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
    }

    .remove-btn:hover {
      background-color: #c82333;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: space-between;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--text-light);
      color: var(--white);
    }

    .btn-secondary:hover {
      background-color: var(--text);
    }

    .btn-danger {
      background-color: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .alert-success {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .alert-danger {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .alert i {
      margin-top: 2px;
    }

    .empty-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }

    select[multiple] {
      height: 150px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--white);
      padding: 2rem;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--danger);
    }

    .modal-body {
      color: var(--text);
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
      }

      .main-content {
        margin: 1rem auto;
      }

      .button-group {
        flex-direction: column;
      }

      .card {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header class="dashboard-header">
    <img src="/images/accNewLog.webp" alt="Company Logo" class="logo" />
    <div class="header-right">
      <p class="user-info">welcome <%=desc_user %> (admin)</p>
      <div>
        <a href="/logout" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Log out
        </a>
      </div>
    </div>
  </header>

  <main class="main-content">
    <a href="/" class="back-link">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>

    <div class="page-title">
      <i class="fas fa-edit"></i> Edit Process
    </div>
    <p class="page-subtitle">Update the process name, description, and workflow departments.</p>

    <% if (successMessage) { %>
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <div><%= successMessage %></div>
      </div>
    <% } %>

    <% if (errorMessage) { %>
      <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        <div><%= errorMessage %></div>
      </div>
    <% } %>

    <div class="card">
      <% if (hasWorkflows) { %>
        <div class="alert alert-danger">
          <i class="fas fa-lock"></i>
          <div>
            <strong>This process has active workflows and cannot be edited.</strong> The process has started and is currently in use. You can view the associated workflows below, but modifications are locked to maintain data integrity.
          </div>
        </div>
      <% } %>

      <form id="editProcessForm" action="/updateProcess/<%= process.NumberOfProccessID %>" method="POST" <%= hasWorkflows ? 'style="opacity: 0.6; pointer-events: none;"' : '' %>>
        <div class="form-group">
          <label for="ProcessName">Process Name</label>
          <input type="text" name="ProcessName" id="ProcessName" required 
                 value="<%= process.ProcessName %>"
                 placeholder="e.g. Employee Onboarding, Purchase Approval"
                 <%= hasWorkflows ? 'disabled' : '' %>>
          <span class="help-text">Give your process a clear, descriptive name that identifies its purpose.</span>
        </div>

        <div class="form-group">
          <label for="processDesc">Description (Optional)</label>
          <textarea name="processDesc" id="processDesc" 
                    placeholder="Briefly describe what this process is for"
                    <%= hasWorkflows ? 'disabled' : '' %>><%= process.processDesc || '' %></textarea>
          <span class="help-text">Add a brief description of the process purpose.</span>
        </div>

        <div class="form-group">
          <label for="Departments">Workflow Departments</label>
          <select name="Departments" id="Departments" multiple required <%= hasWorkflows ? 'disabled' : '' %>>
            <% departments.forEach(dept => { %>
              <option value="<%= dept.DepartmentID %>" 
                      <%= currentDeptIds.includes(dept.DepartmentID) ? 'selected' : '' %>>
                <%= dept.DeptName %>
              </option>
            <% }); %>
          </select>
          <span class="help-text">
            Hold Ctrl/Cmd to select multiple departments. The order you select them will determine the workflow steps.
          </span>
        </div>

        <div class="steps-container">
          <div class="steps-title">Current Workflow Steps</div>
          <div id="steps-list">
            <% if (currentSteps && currentSteps.length > 0) { %>
              <% currentSteps.forEach((step, index) => { %>
                <div class="step-item">
                  <div class="step-number"><%= index + 1 %></div>
                  <div class="step-info">
                    <div class="step-dept-name"><%= step.DeptName %></div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="empty-message">No departments assigned yet.</div>
            <% } %>
          </div>
        </div>

        <div class="button-group">
          <a href="/" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancel
          </a>
          <div>
            <button type="button" class="btn btn-danger" id="deleteBtn" <%= hasWorkflows ? 'disabled' : '' %> title="<%= hasWorkflows ? 'Cannot delete: process has active workflows' : '' %>">
              <i class="fas fa-trash"></i> Delete Process
            </button>
            <button type="submit" class="btn btn-primary" <%= hasWorkflows ? 'disabled' : '' %> title="<%= hasWorkflows ? 'Cannot edit: process has active workflows' : '' %>">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </div>
      </form>

      <% if (hasWorkflows) { %>
        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
        <div style="margin-top: 2rem;">
          <h3 style="color: var(--primary-dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="fas fa-sitemap"></i> Associated Workflows
          </h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
              <thead>
                <tr style="background-color: var(--primary-light); border-bottom: 2px solid var(--primary);">
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Workflow ID</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Project</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Package</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Status</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Created Date</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Start Date</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--primary-dark);">Completion Date</th>
                </tr>
              </thead>
              <tbody>
                <% associatedWorkflows.forEach(workflow => { %>
                  <tr style="border-bottom: 1px solid var(--border); transition: background-color 0.2s;">
                    <td style="padding: 0.75rem; font-weight: 600; color: var(--primary);"><%= workflow.WorkFlowID %></td>
                    <td style="padding: 0.75rem;"><%= workflow.ProjectName || '-' %></td>
                    <td style="padding: 0.75rem;"><%= workflow.PackageName || '-' %></td>
                    <td style="padding: 0.75rem;">
                      <span style="display: inline-block; padding: 0.35rem 0.75rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600;
                        <%= workflow.Status === 'Completed' ? 'background-color: rgba(46, 125, 50, 0.1); color: #2e7d32;' : 'background-color: rgba(245, 158, 11, 0.1); color: var(--warning);' %>">
                        <%= workflow.Status || '-' %>
                      </span>
                    </td>
                    <td style="padding: 0.75rem;"><%= workflow.createdDate ? new Date(workflow.createdDate).toLocaleDateString() : '-' %></td>
                    <td style="padding: 0.75rem;"><%= workflow.startDate ? new Date(workflow.startDate).toLocaleDateString() : '-' %></td>
                    <td style="padding: 0.75rem;"><%= workflow.completionDate ? new Date(workflow.completionDate).toLocaleDateString() : '-' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> This process has <%= associatedWorkflows.length %> workflow<%= associatedWorkflows.length !== 1 ? 's' : '' %> currently running or completed. To edit or delete this process, all associated workflows must be completed first.
          </p>
        </div>
      <% } %>
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-triangle"></i>
        Delete Process
      </div>
      <div class="modal-body">
        Are you sure you want to delete this process? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <script>
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const processId = <%= process.NumberOfProccessID %>;
    const hasWorkflows = <%= hasWorkflows ? 'true' : 'false' %>;

    deleteBtn.addEventListener('click', () => {
      if (hasWorkflows) {
        alert('Cannot delete this process because it has active workflows. Complete or remove all associated workflows first.');
        return;
      }
      deleteModal.classList.add('active');
    });

    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
    });

    confirmDeleteBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/deleteProcess/${processId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.href = '/';
        } else {
          alert('Failed to delete process');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error deleting process');
      }
    });

    // Close modal when clicking outside
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
      }
    });
  </script>
</body>
</html>
