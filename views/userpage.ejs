<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Task Management | My Tasks</title>
<link rel="stylesheet" href="/css/all.min.css">
<link rel="stylesheet" href="/fonts/inter/inter.css">
  <link rel="stylesheet" href="/styles/userpage.css">
  <link rel="stylesheet" href="/styles/utils.css">

</head>
<body data-user-id="<%= user.id %>" data-dept-id="<%= user.DepartmentId %>" data-task-list="<%= JSON.stringify(tasks) %>" data-payment-steps="<%= (typeof paymentSteps !== 'undefined' && paymentSteps) ? JSON.stringify(paymentSteps) : '[]' %>" data-is-admin="<%= user.usrAdmin || false %>">

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Content Area -->
    <div class="content-area">
      <!-- Top Header -->
      <header class="top-header">
        <div class="breadcrumb">
          <a href="/workFlowDash">
            <i class="fas fa-home"></i>
            Dashboard
          </a>
          
          <span class="breadcrumb-separator">/</span>
          <span>My Tasks</span>
        </div>
        
        <div class="header-actions">
          <button class="back-button" id="backBtn">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
          </button>
          <a href="/logout">
    <i class="fas fa-sign-out-alt"></i>
    Logout
  </a>

        </div>
        
      </header>

      <section class="task-management">
        <div class="task-header">
          <h2>
            <i class="fas fa-tasks"></i>
            Task Management
          </h2>
          
          <div class="progress-indicator">
            <span>Task Completion:</span>
            <div class="progress-bar">
              <div class="progress-fill" id="completion-progress"></div>
            </div>
            <span id="completion-percentage">0%</span>
          </div>
        </div>
        
        <!-- Task Timeline Visualization -->
        <div class="task-timeline" id="task-timeline">
          <!-- Timeline items will be inserted here by JavaScript -->
        </div>
        
        <!-- Task Filters -->
        <div class="task-filters">
          <div class="filter-group">
            <label class="filter-label">Filter by:</label>
            <select id="status-filter" class="filter-select">
              <option value="all">All Tasks</option>
              <option value="pending">Pending</option>
              <option value="inprogress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
          
        
          <div class="search-container">
            <input type="text" id="task-search" class="search-input" placeholder="Search tasks...">
            <button id="search-btn" class="search-btn">
              <i class="fas fa-search"></i>
              Search
            </button>
          </div>

          <button id="export-csv-btn" class="export-btn">
            <i class="fas fa-download"></i>
            Export to CSV
          </button>
        </div>
        
        <!-- Status Quick View -->
        <div class="status-quickview">
          <div class="status-item" data-filter="all">
            <span class="status-badge"></span>
            <span>All Tasks</span>
            <span class="status-count" id="total-count">0</span>
          </div>
          <div class="status-item" data-filter="pending">
            <span class="status-badge status-pending"></span>
            <span>Pending</span>
            <span class="status-count" id="pending-count">0</span>
          </div>
          <div class="status-item" data-filter="inprogress">
            <span class="status-badge status-inprogress"></span>
            <span>In Progress</span>
            <span class="status-count" id="inprogress-count">0</span>
          </div>
          <div class="status-item" data-filter="completed">
            <span class="status-badge status-completed"></span>
            <span>Completed</span>
            <span class="status-count" id="completed-count">0</span>
          </div>
          <div class="status-item" data-filter="overdue">
            <span class="status-badge status-overdue"></span>
            <span>Overdue</span>
            <span class="status-count" id="overdue-count">0</span>
          </div>
        </div>
        
        <div class="process-info">
          <div class="info-item">
            <span class="info-label">
              <i class="fas fa-project-diagram"></i>
              Process
            </span>
            <span class="info-value"><%= (typeof tasks !== 'undefined' && tasks && tasks[0]) ? tasks[0].ProcessName : 'N/A' %></span>
          </div>
          <div class="info-item">
            <span class="info-label">
              <i class="fas fa-folder"></i>
              Project
            </span>
            <span class="info-value"><%= (typeof tasks !== 'undefined' && tasks && tasks[0]) ? tasks[0].ProjectName : 'N/A' %></span>
          </div>
          <div class="info-item">
            <span class="info-label">
              <i class="fas fa-box"></i>
              Package
            </span>
            <span class="info-value"><%= (typeof tasks !== 'undefined' && tasks && tasks[0]) ? tasks[0].PkgeName : 'N/A' %></span>
          </div>
        </div>

        <!-- Payment Status Tracker -->
        <% if (typeof paymentSteps !== 'undefined' && paymentSteps && paymentSteps.length > 0) { %>
        <div class="payment-tracker">
          <div class="payment-header">
            <h3 class="payment-title">
              <i class="fas fa-credit-card"></i>
              Payment Progress
            </h3>
            <% if (user.DepartmentId === 11) { %>
              <button id="delete-payment-btn" class="btn-delete-payment">
                <i class="fas fa-trash-alt"></i> Delete Payment
              </button>
            <% } %>
          </div>
          
          <% 
            const activeIndex = paymentSteps.findIndex(s => s.isActive);
            const activeStep = paymentSteps[activeIndex] || null;
            const nextStep = activeIndex >= 0 && activeIndex < paymentSteps.length - 1 ? paymentSteps[activeIndex + 1] : null;
            const allStepsCompleted = paymentSteps.every(s => !s.isActive); // All steps have no active flag
            const allCompleted = allStepsCompleted && activeIndex === -1 && paymentSteps.length > 0;
          %>
          
          <% if (!allCompleted && activeStep) { %>
          <div class="payment-transition-banner">
            <div class="transition-content">
              <div class="transition-icon">
                <i class="fas fa-exchange-alt"></i>
              </div>
              <div class="transition-text">
                <p class="transition-primary">
                  <% if (!nextStep) { %>
                    Payment <%= activeStep.stepNumber %> <span class="highlight">Finishing</span>
                  <% } else { %>
                    Payment <%= activeStep.stepNumber %> <span class="highlight">In Process</span>
                  <% } %>
                </p>
                <% if (nextStep) { %>
                  <p class="transition-secondary">
                    <i class="fas fa-arrow-right"></i> Transitioning to Payment <%= nextStep.stepNumber %>
                  </p>
                <% } else { %>
                  <p class="transition-secondary">
                    <i class="fas fa-flag-checkered"></i> Final Payment Stage
                  </p>
                <% } %>
              </div>
            </div>
          </div>
          <% } %>
          
          <% if (allCompleted) { %>
          <div class="payment-transition-banner">
            <div class="transition-content">
              <div class="transition-icon">
                <i class="fas fa-check-double"></i>
              </div>
              <div class="transition-text">
                <p class="transition-primary">
                  All Payments <span class="highlight">Finished</span>
                </p>
                <p class="transition-secondary">
                  <i class="fas fa-check-circle"></i> All tasks completed successfully
                </p>
              </div>
            </div>
          </div>
          <% } %>
          
          <div class="payment-steps-container">
            <% paymentSteps.forEach((step, index) => { %>
              <div class="payment-step <%= step.isActive ? 'active' : allCompleted || (activeIndex >= 0 && index < activeIndex) ? 'completed' : 'waiting' %>">
                <div class="payment-icon">
                  <% if (step.isActive) { %>
                    <i class="fas fa-spinner fa-spin"></i>
                  <% } else if (allCompleted || (activeIndex >= 0 && index < activeIndex)) { %>
                    <i class="fas fa-check-circle"></i>
                  <% } else { %>
                    <i class="fas fa-clock"></i>
                  <% } %>
                </div>
                <div class="payment-details">
                  <div class="payment-label">Payment <%= step.stepNumber %></div>
                  <div class="payment-status">
                    <% if (step.isActive) { %>
                      <span class="status-badge in-process">
                        <i class="fas fa-play-circle"></i> In Process
                      </span>
                      <% 
                        if (step.stepNumber > 1) {
                          // Check if any task for this payment step has a PlannedDate
                          const paymentTasks = tasks.filter(t => t.PaymentStep === step.stepNumber && t.DepId !== 9);
                          const hasPlannedDate = paymentTasks.some(t => t.PlannedDate);
                          
                          if (!hasPlannedDate) {
                      %>
                        <button class="set-payment-date-btn" data-payment-step="<%= step.stepNumber %>">
                          <i class="fas fa-calendar-plus"></i> Set Start Date
                        </button>
                      <%
                          }
                        }
                      %>
                    <% } else if (allCompleted || (activeIndex >= 0 && index < activeIndex)) { %>
                      <span class="status-badge completed">
                        <i class="fas fa-check"></i> Completed
                      </span>
                    <% } else { %>
                      <span class="status-badge waiting">
                        <i class="fas fa-hourglass-half"></i> Waiting
                      </span>
                    <% } %>
                  </div>
                </div>

              </div>
              <% if (index < paymentSteps.length - 1) { %>
                <div class="payment-connector"></div>
              <% } %>
            <% }); %>
          </div>
        </div>
        <% } %>
        
        <div id="department-tables-container">
          <!-- Department tables will be inserted here by JavaScript -->
        </div>

        <!-- Task History Section (At Bottom) -->
        <div class="task-history-section">
          <div class="section-divider">
            <i class="fas fa-history"></i>
            <h3>Completed Task History</h3>
          </div>
          
          <div id="history-filters" class="task-filters" style="display: none;">
            <div class="filter-group">
              <label for="history-payment-filter">Payment:</label>
              <select id="history-payment-filter">
                <option value="">All Payments</option>
              </select>
            </div>
          </div>

          <div id="history-container" class="history-container">
            <!-- Task history grouped by payment and department will be inserted here -->
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Success Message -->
  <div id="success-message" class="success-message message">
    <i class="fas fa-check-circle"></i>
    <span id="success-text"></span>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="error-message message">
    <i class="fas fa-exclamation-circle"></i>
    <span id="error-text"></span>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">
        <i class="fas fa-question-circle"></i>
        <span id="modal-message">Are you sure you want to perform this action?</span>
      </h3>
      <div class="modal-actions">
        <button id="modal-confirm-btn" class="modal-confirm-btn">Confirm</button>
        <button id="modal-cancel-btn" class="modal-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Payment Start Date Modal -->
  <div id="payment-start-date-modal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">
        <i class="fas fa-calendar-alt"></i>
        Set Start Date for Next Payment
      </h3>
      <div class="modal-body">
        <p>Enter the start date for the next payment step:</p>
        <input type="date" id="payment-start-date-input" class="date-input">
      </div>
      <div class="modal-actions">
        <button id="payment-date-confirm-btn" class="modal-confirm-btn">Continue</button>
        <button id="payment-date-cancel-btn" class="modal-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- EJS Variables for External JavaScript -->

  
  <script src="/js/userpage.js"></script>
</body>
</html>
