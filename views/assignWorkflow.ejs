<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Workflow</title>
  <link rel="stylesheet" href="/styles/task.css">
</head>
<body>
  <div class="form-container">
    <h1>Add Workflow</h1>
    <form action="/postWorkflow" method="POST">
      
      <div class="form-row">
        <label for="WorkflowName">Workflow Name</label>
        <input type="text" name="WorkflowName" id="WorkflowName" required>
      </div>

      <div class="form-row">
        <label for="usrID">Select User</label>
        <select name="usrID" id="usrID" >
           <option value="">-- None --</option>
          <% users.forEach(user => { %>
            <option value="<%= user.usrID %>"><%= user.usrDesc %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label for="TaskID">Select Task</label>
        <select name="TaskID" id="TaskID" required>
          <% tasks.forEach(task => { %>
            <option value="<%= task.TaskID %>"><%= task.TaskName %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label for="PkgeID">Select Package</label>
        <select name="PkgeID" id="PkgeID" required>
          <% packages.forEach(pkg => { %>
            <option value="<%= pkg.PkgeID %>"><%= pkg.PkgeName %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label for="TimeStarted">Time Started</label>
        <input type="datetime-local" name="TimeStarted" id="TimeStarted" required>
      </div>

      <div class="form-row">
        <label for="TimeFinished">Time Finished</label>
        <input type="datetime-local" name="TimeFinished" id="TimeFinished">
      </div>

      <div class="form-actions">
        <button type="submit">Create Workflow</button>
      </div>
    </form>
  </div>
</body>
<script>
  const taskSelect = document.getElementById("TaskID");
  const packageSelect = document.getElementById("PkgeID");

  async function fetchAndFillWorkflow() {
    const taskID = taskSelect.value;
    const pkgeID = packageSelect.value;

    if (!taskID || !pkgeID) return;

    const res = await fetch(`/getWorkflow?TaskID=${taskID}&PkgeID=${pkgeID}`);
    const data = await res.json();

    if (data) {
      document.getElementById("WorkflowName").value = data.WorkflowName || "";
      document.getElementById("usrID").value = data.usrID || "";
      document.getElementById("TimeStarted").value = data.TimeStarted
        ? new Date(data.TimeStarted).toISOString().slice(0, 16)
        : "";
      document.getElementById("TimeFinished").value = data.TimeFinished
        ? new Date(data.TimeFinished).toISOString().slice(0, 16)
        : "";
    } else {
      // Clear fields if no existing workflow
      document.getElementById("WorkflowName").value = "";
      document.getElementById("usrID").value = "";
      document.getElementById("TimeStarted").value = "";
      document.getElementById("TimeFinished").value = "";
    }
  }

  taskSelect.addEventListener("change", fetchAndFillWorkflow);
  packageSelect.addEventListener("change", fetchAndFillWorkflow);
</script>

</html>
